{% extends 'store/base.html' %}
{% load static %}

{% block title %}בוטיק אריה - דף הבית{% endblock %}

{% block content %}
<!-- Hero Banner -->
{% if site_settings and site_settings.hero_banner %}
<section class="hero-banner">
    <div class="hero-image">
        <img src="{{ site_settings.hero_banner.url }}" alt="{{ site_settings.hero_title|default:'מוצרי תינוקות איכותיים' }}">
        {% if site_settings.hero_title or site_settings.hero_subtitle %}
        <div class="hero-content">
            {% if site_settings.hero_title %}
            <h1 class="hero-title">{{ site_settings.hero_title }}</h1>
            {% endif %}
            {% if site_settings.hero_subtitle %}
            <p class="hero-subtitle">{{ site_settings.hero_subtitle }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% else %}
<!-- Default banner if no settings configured -->
<section class="hero-banner">
    <div class="hero-image">
        <img src="{% static 'images/hero-banner.jpg' %}" alt="מוצרי תינוקות איכותיים">
    </div>
</section>
{% endif %}

<!-- Categories Gallery -->
<section class="categories-gallery">
    <div class="container">
        <div class="categories-grid">
            {% for category in categories %}
            <a href="{% url 'category_detail' category.slug %}" class="category-card">
                <div class="category-image">
                    {% if category.image %}
                        <img src="{{ category.image.url }}" alt="{{ category.name }}">
                    {% else %}
                        <img src="https://via.placeholder.com/600x400/E8D5C4/333333?text={{ category.name|urlencode }}" alt="{{ category.name }}">
                    {% endif %}
                    <div class="category-overlay">
                        <h2 class="category-title">{{ category.name }}</h2>
                    </div>
                </div>
            </a>
            {% empty %}
            <!-- Fallback if no categories exist -->
            <p>אין קטגוריות זמינות</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Our Story Section -->
<section class="our-story-section">
    <!-- First div: Blue-gray background -->
    <div class="story-top-bg">
        <div class="container">
            <h2 class="story-title">הסיפור שלנו</h2>
            <p class="story-description">אריה בוטיק מעל 70 שנה של איכות, רכות ומזכרות ילדות</p>
            <a href="#" class="story-button">עוד עלינו</a>
        </div>
    </div>
    
    <!-- Second div: White background -->
    <div class="story-bottom-bg"></div>
    
    <!-- Third div: Absolute positioned gallery -->
    <div class="story-gallery">
        <!-- Mobile carousel navigation arrows -->
        <button class="story-carousel-arrow story-carousel-prev" aria-label="הקודם">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <button class="story-carousel-arrow story-carousel-next" aria-label="הבא">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
        
        <div class="story-gallery-container">
            <div class="story-image-card">
                <div class="story-image-wrapper">
                    <img src="{% static 'images/100 כותנה.png' %}" alt="100% כותנה" class="story-image">
                </div>
                <p class="story-caption">100% כותנה</p>
            </div>
            <div class="story-image-card">
                <div class="story-image-wrapper">
                    <img src="{% static 'images/בד פרימיום.png' %}" alt="בד פרימיום" class="story-image">
                </div>
                <p class="story-caption">בד פרימיום</p>
            </div>
            <div class="story-image-card">
                <div class="story-image-wrapper">
                    <img src="{% static 'images/רכות 100 אחוז.png' %}" alt="100% רכות" class="story-image">
                </div>
                <p class="story-caption">100% רכות</p>
            </div>
            <div class="story-image-card">
                <div class="story-image-wrapper">
                    <img src="{% static 'images/הדפסים יחודיים.png' %}" alt="הדפסים ייחודיים" class="story-image">
                </div>
                <p class="story-caption">הדפסים ייחודיים</p>
            </div>
        </div>
        
        <!-- Mobile carousel pagination dots -->
        <div class="story-carousel-dots">
            <span class="story-dot active" data-index="0"></span>
            <span class="story-dot" data-index="1"></span>
            <span class="story-dot" data-index="2"></span>
            <span class="story-dot" data-index="3"></span>
        </div>
    </div>
</section>

<!-- Bestseller Products Section -->
{% if bestseller_products %}
<section class="bestsellers-section">
    <div class="container">
        <h2 class="bestsellers-title">הכי נמכרים שלנו</h2>
        
        <div class="products-gallery">
            {% for product in bestseller_products %}
            <div class="product-card">
                <!-- Heart Icon -->
                <button type="button" class="product-heart-btn {% if product.id in wishlist_product_ids %}active{% endif %}" data-product-id="{{ product.id }}" aria-label="הוסף לרשימת משאלות">
                    {% if product.id in wishlist_product_ids %}
                        <img src="{% static 'images/hert icon fill.svg' %}" alt="לב" class="product-heart-icon">
                    {% else %}
                        <img src="{% static 'images/ALL_PHOTOS SERCH HAMBURGER_HEART copy.svg' %}" alt="לב" class="product-heart-icon">
                    {% endif %}
                </button>
                
                <a href="{% url 'product_detail' product.slug %}" class="product-card-link">
                    <div class="product-image-wrapper">
                        <!-- Product Image -->
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-card-image">
                        {% else %}
                            <div class="product-card-placeholder">אין תמונה</div>
                        {% endif %}
                    </div>
                    
                    <div class="product-card-info">
                        <p class="product-card-name">{{ product.name }}</p>
                        {% if product.subtitle %}
                            <p class="product-card-subtitle">{{ product.subtitle }}</p>
                        {% endif %}
                        <p class="product-card-price">{{ product.price }} ש"ח</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Gallery Below Bestsellers Section -->
{% if below_bestsellers_gallery and below_bestsellers_gallery.right_image and below_bestsellers_gallery.left_image %}
<section class="below-bestsellers-gallery">
    <div class="gallery-images">
        <div class="gallery-image-wrapper">
            <img src="{{ below_bestsellers_gallery.right_image.url }}" alt="תמונה ימנית" class="gallery-image">
        </div>
        <div class="gallery-image-wrapper">
            <img src="{{ below_bestsellers_gallery.left_image.url }}" alt="תמונה שמאלית" class="gallery-image">
        </div>
    </div>
</section>
{% endif %}

<!-- Retailer Stores Carousel Section -->
{% if retailer_stores %}
<section class="retailers-section">
    <div class="container">
        <h2 class="retailers-title">את הבייסיקים הלבנים שלנו אתם יכולים למצוא בחנויות ברחבי הארץ</h2>
        
        <div class="retailers-carousel">
            <button class="retailers-arrow retailers-arrow-prev" aria-label="חנויות קודמות" {% if retailer_stores|length <= 6 %}style="display: none;"{% endif %}>
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            
            <div class="retailers-wrapper">
                <div class="retailers-track" id="retailers-track">
                    {% for store in retailer_stores %}
                    <div class="retailer-item">
                        {% if store.website_url %}
                        <a href="{{ store.website_url }}" target="_blank" rel="noopener noreferrer" class="retailer-link">
                            <img src="{{ store.logo.url }}" alt="{{ store.name }}" class="retailer-logo">
                        </a>
                        {% else %}
                        <img src="{{ store.logo.url }}" alt="{{ store.name }}" class="retailer-logo">
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <button class="retailers-arrow retailers-arrow-next" aria-label="חנויות הבאות" {% if retailer_stores|length <= 6 %}style="display: none;"{% endif %}>
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
        </div>
    </div>
</section>
{% endif %}

<!-- Instagram Gallery Section -->
{% if instagram_gallery %}
<section class="instagram-gallery-section">
    <div class="container">
        <h2 class="instagram-gallery-title">חפשו אותנו באינסטגרם</h2>
        
        <div class="instagram-gallery-grid">
            <a href="{{ instagram_gallery.instagram_url }}" target="_blank" rel="noopener noreferrer" class="instagram-gallery-item">
                <img src="{{ instagram_gallery.image_1.url }}" alt="Instagram 1" class="instagram-gallery-image">
            </a>
            <a href="{{ instagram_gallery.instagram_url }}" target="_blank" rel="noopener noreferrer" class="instagram-gallery-item">
                <img src="{{ instagram_gallery.image_2.url }}" alt="Instagram 2" class="instagram-gallery-image">
            </a>
            <a href="{{ instagram_gallery.instagram_url }}" target="_blank" rel="noopener noreferrer" class="instagram-gallery-item">
                <img src="{{ instagram_gallery.image_3.url }}" alt="Instagram 3" class="instagram-gallery-image">
            </a>
            {% if instagram_gallery.image_4 %}
            <a href="{{ instagram_gallery.instagram_url }}" target="_blank" rel="noopener noreferrer" class="instagram-gallery-item">
                <img src="{{ instagram_gallery.image_4.url }}" alt="Instagram 4" class="instagram-gallery-image">
            </a>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Heart button click handler - Wishlist toggle
        const heartButtons = document.querySelectorAll('.product-heart-btn');
        heartButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                {% if not user.is_authenticated %}
                    // Redirect to login if not authenticated
                    window.location.href = '/users/login/?next={{ request.path }}';
                    return;
                {% endif %}
                
                const productId = this.getAttribute('data-product-id');
                const heartIcon = this.querySelector('.product-heart-icon');
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                  document.querySelector('[name="csrfmiddlewaretoken"]')?.value ||
                                  '{{ csrf_token }}';
                
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    return;
                }
                
                // Send AJAX request
                fetch(`/wishlist/toggle/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Toggle heart button state and image
                        const heartIcon = this.querySelector('.product-heart-icon');
                        if (data.action === 'added') {
                            this.classList.add('active');
                            heartIcon.src = '/static/images/hert icon fill.svg';
                        } else {
                            this.classList.remove('active');
                            heartIcon.src = '/static/images/ALL_PHOTOS SERCH HAMBURGER_HEART copy.svg';
                        }
                        
                        // Update header wishlist icon based on wishlist count
                        const headerWishlistIcon = document.getElementById('header-wishlist-icon');
                        if (headerWishlistIcon) {
                            if (data.wishlist_count > 0) {
                                headerWishlistIcon.src = '/static/images/hert icon fill.svg';
                            } else {
                                headerWishlistIcon.src = '/static/images/ALL_PHOTOS SERCH HAMBURGER_HEART copy.svg';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // Retailers Carousel functionality (transform-based, aligned)
        const retailersCarousel = document.querySelector('.retailers-carousel');
        if (retailersCarousel) {
            const track = document.getElementById('retailers-track');
            const items = track ? track.querySelectorAll('.retailer-item') : [];
            const wrapper = document.querySelector('.retailers-wrapper');
            const prevButton = retailersCarousel.querySelector('.retailers-arrow-prev');
            const nextButton = retailersCarousel.querySelector('.retailers-arrow-next');
            
            let currentIndex = 0;
            const totalItems = items.length;
            const gap = 20;
            
            function getVisibleCount() {
                if (!items.length || !wrapper) return 1;
                const itemWidth = items[0].offsetWidth;
                // Calculate arrow widths based on screen size
                const isMobile = window.innerWidth <= 480;
                const isTablet = window.innerWidth <= 768;
                let arrowsWidth = 90 + 40; // 2 arrows + 2 gaps
                if (isMobile) arrowsWidth = 64 + 20; // smaller arrows on mobile
                else if (isTablet) arrowsWidth = 76 + 30;
                
                // Use parent width to calculate how many items fit
                const parentWidth = wrapper.parentElement ? wrapper.parentElement.offsetWidth - arrowsWidth : wrapper.offsetWidth;
                return Math.max(2, Math.floor((parentWidth + gap) / (itemWidth + gap)));
            }
            
            function getMaxIndex() {
                return Math.max(0, totalItems - getVisibleCount());
            }
            
            function adjustWrapperWidth() {
                if (!items.length || !wrapper) return;
                const itemWidth = items[0].offsetWidth;
                const visibleCount = getVisibleCount();
                // Set exact width to fit N complete items
                const exactWidth = visibleCount * itemWidth + (visibleCount - 1) * gap;
                wrapper.style.width = exactWidth + 'px';
                wrapper.style.flex = 'none';
            }
            
            function updateCarousel() {
                if (!track || !items.length) return;
                
                adjustWrapperWidth();
                
                const maxIndex = getMaxIndex();
                if (currentIndex > maxIndex) currentIndex = maxIndex;
                if (currentIndex < 0) currentIndex = 0;
                
                const itemWidth = items[0].offsetWidth;
                const offset = currentIndex * (itemWidth + gap);
                track.style.transform = 'translateX(' + offset + 'px)';
                
                // Update arrows
                if (prevButton) {
                    prevButton.style.opacity = currentIndex >= maxIndex ? '0.3' : '1';
                    prevButton.style.pointerEvents = currentIndex >= maxIndex ? 'none' : 'auto';
                }
                if (nextButton) {
                    nextButton.style.opacity = currentIndex <= 0 ? '0.3' : '1';
                    nextButton.style.pointerEvents = currentIndex <= 0 ? 'none' : 'auto';
                }
                }
                
                if (prevButton) {
                prevButton.addEventListener('click', function() {
                    currentIndex++;
                        updateCarousel();
                    });
                }
                
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    currentIndex--;
                        updateCarousel();
                });
            }
            
            window.addEventListener('resize', updateCarousel);
            updateCarousel();
        }
        
        // Story Gallery Mobile Carousel
        const storyGallery = document.querySelector('.story-gallery');
        if (storyGallery) {
            const container = storyGallery.querySelector('.story-gallery-container');
            const cards = storyGallery.querySelectorAll('.story-image-card');
            const prevBtn = storyGallery.querySelector('.story-carousel-prev');
            const nextBtn = storyGallery.querySelector('.story-carousel-next');
            const dots = storyGallery.querySelectorAll('.story-dot');
            
            let currentSlide = 0;
            const totalSlides = cards.length;
            
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            function updateStoryCarousel() {
                if (!isMobile()) return;
                
                // Move slides using transform
                cards.forEach((card, index) => {
                    card.style.transform = `translateX(${(index - currentSlide) * 100}%)`;
                });
                
                // Update dots
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentSlide);
                });
            }
            
            // Previous button click (moves to next in RTL)
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentSlide < totalSlides - 1) {
                        currentSlide++;
                        updateStoryCarousel();
                    }
                });
            }
            
            // Next button click (moves to previous in RTL)
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentSlide > 0) {
                        currentSlide--;
                        updateStoryCarousel();
                    }
                });
            }
            
            // Dot click handler
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    currentSlide = index;
                    updateStoryCarousel();
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (isMobile()) {
                    updateStoryCarousel();
                } else {
                    // Reset transforms on desktop
                    cards.forEach(card => {
                        card.style.transform = '';
                    });
                }
            });
            
            // Initial setup
            if (isMobile()) {
                updateStoryCarousel();
            }
        }
    });
</script>
{% endblock %}

