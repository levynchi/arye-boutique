{% extends 'store/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - בוטיק אריה{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<section class="breadcrumb-section">
    <div class="container">
        <nav class="breadcrumb-nav">
            <a href="{% url 'home' %}">דף הבית</a>
            <span class="breadcrumb-separator">></span>
            <a href="{% url 'category_detail' product.category.slug %}">{{ product.category.name }}</a>
            {% if product.subcategory %}
            <span class="breadcrumb-separator">></span>
            <a href="{% url 'subcategory_detail' product.subcategory.category.slug product.subcategory.slug %}">{{ product.subcategory.name }}</a>
            {% endif %}
            <span class="breadcrumb-separator">></span>
            <span class="breadcrumb-current">{{ product.name }}</span>
        </nav>
    </div>
</section>

<!-- Product Detail Section -->
<section class="product-detail-section">
    <div class="container">
        <div class="product-detail-container">
            <!-- Right Side - Product Images -->
            <div class="product-images-column">
                <!-- Main Product Image -->
                <div class="main-product-image">
                    {% if additional_images %}
                    <button type="button" class="gallery-arrow gallery-arrow-right" id="gallery-prev" aria-label="תמונה קודמת">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    {% endif %}
                    {% if primary_image %}
                        <img src="{{ primary_image.url }}" alt="{{ product.name }}" id="main-product-img">
                    {% else %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" id="main-product-img">
                    {% endif %}
                    {% if additional_images %}
                    <button type="button" class="gallery-arrow gallery-arrow-left" id="gallery-next" aria-label="תמונה הבאה">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                
                <!-- Thumbnail Images -->
                {% if additional_images %}
                <div class="product-thumbnails">
                    <!-- Primary/Main Image Thumbnail -->
                    {% if primary_image %}
                    <div class="thumbnail-item active" data-image-url="{{ primary_image.url }}">
                        <img src="{{ primary_image.url }}" alt="{{ product.name }}">
                    </div>
                    {% elif product.image %}
                    <div class="thumbnail-item active" data-image-url="{{ product.image.url }}">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                    </div>
                    {% endif %}
                    <!-- Additional Images Thumbnails -->
                    {% for img in additional_images %}
                    {% if not img.is_primary %}
                    <div class="thumbnail-item" data-image-url="{{ img.image.url }}">
                        <img src="{{ img.image.url }}" alt="{{ product.name }}">
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Left Side - Product Information -->
            <div class="product-info-column">
                <div class="product-header-info">
                    <h1 class="product-name">{{ product.name }}</h1>
                    
                    {% if product.subtitle %}
                    <p class="product-subtitle">{{ product.subtitle }}</p>
                    {% endif %}
                    
                    <p class="product-price">{{ product.price }} ש"ח</p>
                </div>
                
                {% if product.size and not has_variants %}
                <div class="product-size">
                    <span class="size-label">גודל:</span>
                    <span class="size-value">{{ product.size }}</span>
                </div>
                {% endif %}
                
                {% if has_variants %}
                <!-- Variant Selection -->
                <div class="variant-selection">
                    <!-- Fabric Type Selection -->
                    <div class="fabric-selection">
                        <label class="selection-label">בחר סוג בד:</label>
                        <div class="fabric-options" id="fabric-options">
                            {% for fabric in fabric_types %}
                            <button type="button" class="fabric-option" data-fabric-id="{{ fabric.id }}">
                                {{ fabric.name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Size Selection -->
                    <div class="size-selection" id="size-selection" style="display: none;">
                        <label class="selection-label">בחר מידה:</label>
                        <div class="size-options" id="size-options">
                            <!-- Sizes will be populated by JavaScript -->
                        </div>
                        <p class="selection-hint">אנא בחר סוג בד תחילה</p>
                    </div>
                </div>
                {% endif %}
                
                <!-- Quantity Selector -->
                <div class="product-quantity">
                    <label for="quantity-input" class="quantity-label">כמות</label>
                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn quantity-minus" id="quantity-minus">-</button>
                        <input type="number" id="quantity-input" class="quantity-input" value="1" min="1" max="{{ product.stock_quantity }}" readonly>
                        <button type="button" class="quantity-btn quantity-plus" id="quantity-plus">+</button>
                    </div>
                </div>
                
                <!-- Add to Cart Form -->
                <form method="POST" action="{% url 'add_to_cart' product.id %}" class="add-to-cart-form">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" id="hidden-quantity" value="1">
                    {% if has_variants %}
                    <input type="hidden" name="variant_id" id="hidden-variant-id" value="">
                    {% endif %}
                    <button type="submit" class="add-to-cart-btn" {% if not product.is_in_stock %}disabled{% endif %} id="add-to-cart-btn">
                        {% if product.is_in_stock %}
                            {% if has_variants %}
                                בחר אפשרויות להוספה
                            {% else %}
                                הוספה להזמנה
                            {% endif %}
                        {% else %}
                            לא במלאי
                        {% endif %}
                    </button>
                </form>
                
                <!-- Expandable Information Sections -->
                <div class="product-info-sections">
                    <div class="info-section">
                        <div class="info-section-header">
                            <span class="info-icon"><i class="fas fa-info-circle"></i></span>
                            <h3 class="info-title">תיאור מוצר</h3>
                            <span class="info-toggle">+</span>
                        </div>
                        <div class="info-section-content" style="display: none;">
                            <p>{{ product.description }}</p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-section-header">
                            <span class="info-icon"><i class="fas fa-tshirt"></i></span>
                            <h3 class="info-title">הרכב חומרים וטיפול</h3>
                            <span class="info-toggle">+</span>
                        </div>
                        <div class="info-section-content" style="display: none;">
                            <p>מידע על הרכב חומרים וטיפול יוצג כאן</p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-section-header">
                            <span class="info-icon"><i class="fas fa-truck"></i></span>
                            <h3 class="info-title">משלוחים והחזרות</h3>
                            <span class="info-toggle">+</span>
                        </div>
                        <div class="info-section-content" style="display: none;">
                            <p>מידע על משלוחים והחזרות יוצג כאן</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Variants data from server
    const variantsData = {{ variants_json|safe }};
    const hasVariants = {{ has_variants|yesno:"true,false" }};
    
    // State
    let selectedFabricId = null;
    let selectedVariantId = null;
    
    // Thumbnail image click handler
    document.addEventListener('DOMContentLoaded', function() {
        const thumbnails = document.querySelectorAll('.thumbnail-item');
        const mainImage = document.getElementById('main-product-img');
        let currentImageIndex = 0;
        
        // Find initially active thumbnail
        thumbnails.forEach((thumb, index) => {
            if (thumb.classList.contains('active')) {
                currentImageIndex = index;
            }
        });
        
        thumbnails.forEach((thumbnail, index) => {
            thumbnail.addEventListener('click', function() {
                // Remove active class from all thumbnails
                thumbnails.forEach(t => t.classList.remove('active'));
                // Add active class to clicked thumbnail
                this.classList.add('active');
                // Update main image
                const imageUrl = this.getAttribute('data-image-url');
                if (mainImage && imageUrl) {
                    mainImage.src = imageUrl;
                }
                // Update current index
                currentImageIndex = index;
            });
        });
        
        // Gallery arrow navigation
        const prevBtn = document.getElementById('gallery-prev');
        const nextBtn = document.getElementById('gallery-next');
        
        function navigateGallery(direction) {
            if (thumbnails.length === 0) return;
            
            // Calculate new index
            if (direction === 'next') {
                currentImageIndex = (currentImageIndex + 1) % thumbnails.length;
            } else {
                currentImageIndex = (currentImageIndex - 1 + thumbnails.length) % thumbnails.length;
            }
            
            // Trigger click on the target thumbnail
            thumbnails[currentImageIndex].click();
        }
        
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                navigateGallery('prev');
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                navigateGallery('next');
            });
        }
        
        // Variant selection logic
        if (hasVariants) {
            const fabricOptions = document.querySelectorAll('.fabric-option');
            const sizeSelection = document.getElementById('size-selection');
            const sizeOptions = document.getElementById('size-options');
            const hiddenVariantId = document.getElementById('hidden-variant-id');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            
            // Fabric selection
            fabricOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all fabric options
                    fabricOptions.forEach(opt => opt.classList.remove('active'));
                    // Add active to clicked option
                    this.classList.add('active');
                    
                    // Get selected fabric ID
                    selectedFabricId = this.getAttribute('data-fabric-id');
                    
                    // Show size selection
                    sizeSelection.style.display = 'block';
                    
                    // Populate sizes for this fabric
                    populateSizes(selectedFabricId);
                    
                    // Reset size selection
                    selectedVariantId = null;
                    hiddenVariantId.value = '';
                    updateAddToCartButton();
                });
            });
            
            function populateSizes(fabricId) {
                const fabric = variantsData[fabricId];
                if (!fabric || !fabric.sizes || fabric.sizes.length === 0) {
                    sizeOptions.innerHTML = '<p class="no-sizes">אין מידות זמינות לבד זה</p>';
                    return;
                }
                
                sizeOptions.innerHTML = '';
                fabric.sizes.forEach(sizeData => {
                    const sizeBtn = document.createElement('button');
                    sizeBtn.type = 'button';
                    sizeBtn.className = 'size-option';
                    sizeBtn.textContent = sizeData.size;
                    sizeBtn.setAttribute('data-variant-id', sizeData.id);
                    
                    sizeBtn.addEventListener('click', function() {
                        // Remove active from all size options
                        document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('active'));
                        // Add active to clicked option
                        this.classList.add('active');
                        
                        // Set selected variant
                        selectedVariantId = this.getAttribute('data-variant-id');
                        hiddenVariantId.value = selectedVariantId;
                        
                        updateAddToCartButton();
                    });
                    
                    sizeOptions.appendChild(sizeBtn);
                });
            }
            
            function updateAddToCartButton() {
                if (selectedVariantId) {
                    addToCartBtn.disabled = false;
                    addToCartBtn.textContent = 'הוספה להזמנה';
                } else {
                    addToCartBtn.disabled = true;
                    addToCartBtn.textContent = 'בחר אפשרויות להוספה';
                }
            }
        }
        
        // Quantity selector
        const quantityInput = document.getElementById('quantity-input');
        const quantityMinus = document.getElementById('quantity-minus');
        const quantityPlus = document.getElementById('quantity-plus');
        const hiddenQuantity = document.getElementById('hidden-quantity');
        
        if (quantityMinus) {
            quantityMinus.addEventListener('click', function(e) {
                e.preventDefault();
                let currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                    hiddenQuantity.value = quantityInput.value;
                }
            });
        }
        
        if (quantityPlus) {
            quantityPlus.addEventListener('click', function(e) {
                e.preventDefault();
                let currentValue = parseInt(quantityInput.value);
                const maxValue = parseInt(quantityInput.getAttribute('max'));
                if (currentValue < maxValue) {
                    quantityInput.value = currentValue + 1;
                    hiddenQuantity.value = quantityInput.value;
                }
            });
        }
        
        // Expandable info sections
        const infoHeaders = document.querySelectorAll('.info-section-header');
        infoHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const content = this.closest('.info-section').querySelector('.info-section-content');
                const toggle = this.querySelector('.info-toggle');
                const isOpen = content.style.display !== 'none';
                
                if (isOpen) {
                    content.style.display = 'none';
                    toggle.textContent = '+';
                } else {
                    content.style.display = 'block';
                    toggle.textContent = '−';
                }
            });
        });
        
        // Close message buttons
        const messageCloseButtons = document.querySelectorAll('.message-close');
        messageCloseButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.message').style.display = 'none';
            });
        });
        
        // Auto-hide messages after 5 seconds
        const messages = document.querySelectorAll('.message');
        messages.forEach(message => {
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 300);
            }, 5000);
        });
        
        // Handle add to cart form with AJAX
        const addToCartForm = document.querySelector('.add-to-cart-form');
        if (addToCartForm) {
            addToCartForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const actionUrl = this.getAttribute('action');
                
                fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Open cart sidebar
                        if (typeof window.openCartSidebar === 'function') {
                            window.openCartSidebar();
                        }
                    } else {
                        // Show error message
                        alert(data.error || 'אירעה שגיאה בהוספת המוצר לעגלה');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('אירעה שגיאה בהוספת המוצר לעגלה');
                });
            });
        }
    });
</script>
{% endblock %}

