{% extends 'store/base.html' %}
{% load static %}

{% block title %}רשימת המשאלות שלי - בוטיק אריה{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<section class="breadcrumb-section">
    <div class="container">
        <nav class="breadcrumb-nav">
            <a href="{% url 'home' %}">דף הבית</a>
            <span class="breadcrumb-separator">></span>
            <span class="breadcrumb-current">רשימת המשאלות שלי</span>
        </nav>
    </div>
</section>

<!-- Wishlist Section -->
<section class="category-detail-section">
    <div class="container">
        <!-- Wishlist Title -->
        <h1 class="category-title">רשימת המשאלות שלי</h1>
        
        {% if messages %}
            <div class="messages-container" role="status" aria-live="polite" aria-atomic="true">
                {% for message in messages %}
                    <div class="message message-{{ message.tags }}">
                        {{ message }}
                        <button type="button" class="message-close" aria-label="סגור הודעה">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% if products %}
            <!-- Products Gallery -->
            <div class="products-gallery">
                {% for product in products %}
                <div class="product-card" data-product-id="{{ product.id }}">
                    <!-- Remove Button (X) -->
                    <button type="button" class="wishlist-remove-btn" data-product-id="{{ product.id }}" aria-label="הסר מרשימת משאלות">
                        &times;
                    </button>
                    
                    <a href="{% url 'product_detail' product.slug %}" class="product-card-link">
                        <div class="product-image-wrapper"
                             data-images='[{% if product.image %}"{{ product.image.url }}"{% endif %}{% for img in product.images.all %}{% if product.image or not forloop.first %},{% endif %}"{{ img.image.url }}"{% endfor %}]'
                             data-current-index="0">
                            <!-- Product Image -->
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-card-image">
                            {% else %}
                                <div class="product-card-placeholder">אין תמונה</div>
                            {% endif %}
                            
                            <!-- Gallery Arrows (shown only if multiple images) -->
                            {% if product.images.all|length > 0 or product.image and product.images.all|length > 0 %}
                            <button type="button" class="product-card-arrow product-card-arrow-right" aria-label="תמונה הבאה">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                            <button type="button" class="product-card-arrow product-card-arrow-left" aria-label="תמונה קודמת">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <!-- Gallery Dots (for mobile) -->
                            <div class="product-card-dots">
                                <span class="product-card-dot active"></span>
                                {% for img in product.images.all %}
                                <span class="product-card-dot"></span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Quick Add to Cart Button -->
                            <button type="button" class="product-card-quick-add" data-product-id="{{ product.id }}" aria-label="הוספה לעגלה">
                                הוספה לעגלה
                            </button>
                        </div>
                        
                        <div class="product-card-info">
                            {% if product.subcategory %}
                                <p class="product-card-subcategory">{{ product.subcategory.name }}</p>
                            {% endif %}
                            <p class="product-card-name">{{ product.name }}</p>
                            <p class="product-card-price">{{ product.price }} ש"ח</p>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty Wishlist Message -->
            <div class="wishlist-empty">
                <p class="wishlist-empty-text">רשימת המשאלות שלך ריקה</p>
                <p class="wishlist-empty-subtext">התחל להוסיף מוצרים שאתה אוהב על ידי לחיצה על סמל הלב</p>
                <a href="{% url 'home' %}" class="wishlist-empty-btn">המשך לקניות</a>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/product-options-panel.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Remove from wishlist
        const removeButtons = document.querySelectorAll('.wishlist-remove-btn');
        removeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const productId = this.getAttribute('data-product-id');
                const productCard = this.closest('.product-card');
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                
                // Send AJAX request
                fetch(`/wishlist/remove/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove product card with animation
                        productCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        productCard.style.opacity = '0';
                        productCard.style.transform = 'scale(0.9)';
                        
                        // Update header wishlist icon based on wishlist count
                        const headerWishlistIcon = document.getElementById('header-wishlist-icon');
                        if (headerWishlistIcon) {
                            if (data.wishlist_count > 0) {
                                headerWishlistIcon.src = '/static/images/hert icon fill.svg';
                            } else {
                                headerWishlistIcon.src = '/static/images/ALL_PHOTOS SERCH HAMBURGER_HEART copy.svg';
                            }
                        }
                        
                        setTimeout(() => {
                            productCard.remove();
                            
                            // Check if wishlist is empty
                            const remainingProducts = document.querySelectorAll('.product-card').length;
                            if (remainingProducts === 0) {
                                location.reload();
                            }
                        }, 300);
                    } else {
                        alert('אירעה שגיאה בהסרת המוצר');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('אירעה שגיאה בהסרת המוצר');
                });
            });
        });
        
        // Product card gallery navigation
        function updateProductCardImage(wrapper, newIndex) {
            const img = wrapper.querySelector('.product-card-image');
            if (!img) return;
            
            let images;
            try {
                images = JSON.parse(wrapper.dataset.images);
            } catch (err) {
                return;
            }
            
            if (!images || images.length <= 1) return;
            
            // Ensure index is within bounds
            newIndex = ((newIndex % images.length) + images.length) % images.length;
            
            wrapper.dataset.currentIndex = newIndex;
            img.src = images[newIndex];
            
            // Update dots
            const dots = wrapper.querySelectorAll('.product-card-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === newIndex);
            });
        }
        
        // Arrow click handlers
        const productCardArrows = document.querySelectorAll('.product-card-arrow');
        productCardArrows.forEach(arrow => {
            arrow.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const wrapper = this.closest('.product-image-wrapper');
                let currentIndex = parseInt(wrapper.dataset.currentIndex) || 0;
                
                if (this.classList.contains('product-card-arrow-right')) {
                    updateProductCardImage(wrapper, currentIndex + 1);
                } else {
                    updateProductCardImage(wrapper, currentIndex - 1);
                }
            });
        });
        
        // Touch swipe support for mobile
        const productImageWrappers = document.querySelectorAll('.product-image-wrapper[data-images]');
        productImageWrappers.forEach(wrapper => {
            let touchStartX = 0;
            let touchEndX = 0;
            
            wrapper.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            wrapper.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > 50) { // Minimum swipe distance
                    e.preventDefault();
                    let currentIndex = parseInt(wrapper.dataset.currentIndex) || 0;
                    
                    if (diff > 0) {
                        // Swipe left - next image
                        updateProductCardImage(wrapper, currentIndex + 1);
                    } else {
                        // Swipe right - previous image
                        updateProductCardImage(wrapper, currentIndex - 1);
                    }
                }
            });
        });
        
        // Quick add button handler
        const quickAddButtons = document.querySelectorAll('.product-card-quick-add');
        quickAddButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const productId = this.getAttribute('data-product-id');
                
                // Open product options panel
                if (typeof openProductOptionsPanel === 'function') {
                    openProductOptionsPanel(productId);
                } else {
                    // Fallback: redirect to product page
                    const productCard = this.closest('.product-card');
                    const productLink = productCard.querySelector('.product-card-link');
                    if (productLink) {
                        window.location.href = productLink.href;
                    }
                }
            });
        });
    });
</script>
{% endblock %}

